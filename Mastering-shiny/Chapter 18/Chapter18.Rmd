---
title: "Chapter18 - Functions"
output: html_notebook
---

```{r setup}
knitr::opts_chunk$set(eval = FALSE)
```


```{r}
library(shiny)
```

The key benefits of a function in the UI tend to be around reducing duplication. The key benefits of functions in a server tend to be around isolation and testing.

# 18.1 File organisation


* I recommend putting large functions (and any smaller helper functions that they need) into their own `R/{function-name}.R` file.

* You might want to collect smaller, simpler, functions into one place. I often use `R/utils.R` for this, but if theyâ€™re primarily used in your ui you might use `R/ui.R`.

# 18.2 UI functions

```{r}
ui <- fluidRow(
  sliderInput("alpha", "alpha", min = 0, max = 1, value = 0.5, step = 0.1),
  sliderInput("beta",  "beta",  min = 0, max = 1, value = 0.5, step = 0.1),
  sliderInput("gamma", "gamma", min = 0, max = 1, value = 0.5, step = 0.1),
  sliderInput("delta", "delta", min = 0, max = 1, value = 0.5, step = 0.1)
)
```


```{r}
sliderInput01 <- function(id) {
  sliderInput(id, label = id, min = 0, max = 1, value = 0.5, step = 0.1)
}

ui <- fluidRow(
  sliderInput01("alpha"),
  sliderInput01("beta"),
  sliderInput01("gamma"),
  sliderInput01("delta")
)
```

## 18.2.1 Functional programming

```{r}
library(purrr)

vars <- c("alpha", "beta", "gamma", "delta")
sliders <- map(vars, sliderInput01)
ui <- fluidRow(sliders)
```


```{r}
vars <- tibble::tribble(
  ~ id,   ~ min, ~ max,
  "alpha",     0,     1,
  "beta",      0,    10,
  "gamma",    -1,     1,
  "delta",     0,     1,
)

mySliderInput <- function(id, label = id, min = 0, max = 1) {
  sliderInput(id, label, min = min, max = max, value = 0.5, step = 0.1)
}

sliders <- pmap(vars, mySliderInput)
```

## 18.2.2 Other applications

```{r}
usWeekDateInput <- function(inputId, ...) {
  dateInput(inputId, ..., format = "dd M, yy", daysofweekdisabled = c(0, 6))
}

# -------------

iconRadioButtons <- function(inputId, label, choices, selected = NULL) {
  names <- lapply(choices, icon)
  values <- if (is.null(names(choices))) names(choices) else choices
  radioButtons(inputId,
    label = label,
    choiceNames = names, choiceValues = values, selected = selected
  )
}

# ------------

stateSelectInput <- function(inputId, ...) {
  selectInput(inputId, ..., choices = state.name)
}
```

# 18.3 Server functions

## 18.3.1 Reading uploaded data

```{r}
server <- function(input, output, session) {
  data <- reactive({
    req(input$file)
    
    ext <- tools::file_ext(input$file$name)
    switch(ext,
      csv = vroom::vroom(input$file$datapath, delim = ","),
      tsv = vroom::vroom(input$file$datapath, delim = "\t"),
      validate("Invalid file; Please upload a .csv or .tsv file")
    )
  })
  
  output$head <- renderTable({
    head(data(), input$n)
  })
}
```


```{r}

# R/load_file.R

load_file <- function(name, path) {
  ext <- tools::file_ext(name)
  switch(ext,
    csv = vroom::vroom(path, delim = ","),
    tsv = vroom::vroom(path, delim = "\t"),
    validate("Invalid file; Please upload a .csv or .tsv file")
  )
}

server <- function(input, output, session) {
  data <- reactive({
    req(input$file)
    load_file(input$file$name, input$file$datapath)
  })
  
  output$head <- renderTable({
    head(data(), input$n)
  })
}
```

## 18.3.2 Internal functions


```{r}
server <- function(input, output, session) {
  switch_page <- function(i) {
    updateTabsetPanel(session, "wizard", selected = paste0("page_", i))
  }
  
  observeEvent(input$page_12, switch_page(2))
  observeEvent(input$page_21, switch_page(1))
  observeEvent(input$page_23, switch_page(3))
  observeEvent(input$page_32, switch_page(2))
}
```


```{r}
switch_page <- function(session, i) {
  updateTabsetPanel(session, "wizard", selected = paste0("page_", i))
}

server <- function(input, output, session) {
  observeEvent(input$page_12, switch_page(session, 2))
  observeEvent(input$page_21, switch_page(session, 1))
  observeEvent(input$page_23, switch_page(session, 3))
  observeEvent(input$page_32, switch_page(session, 2))
}
```

# 18.4 Exercises

### question 1

```{r}
library(tidyverse)

ui <- fluidPage(
  selectInput(inputId = "x",
              label = "X-axis:",
              choices = c("sleep_total", "sleep_rem", "sleep_cycle", 
                          "awake", "brainwt", "bodywt"),
              selected = "sleep_rem"),
  selectInput(inputId = "y",
              label = "Y-axis:",
              choices = c("sleep_total", "sleep_rem", "sleep_cycle", 
                          "awake", "brainwt", "bodywt"),
              selected = "sleep_total"),
  tabsetPanel(id = "vore",
              tabPanel("Carnivore",
                       plotOutput("plot_carni")),
              tabPanel("Omnivore",
                       plotOutput("plot_omni")),
              tabPanel("Herbivore",
                       plotOutput("plot_herbi")))
)

server <- function(input, output, session) {

  # make subsets
  carni <- reactive( filter(msleep, vore == "carni") )
  omni  <- reactive( filter(msleep, vore == "omni")  )
  herbi <- reactive( filter(msleep, vore == "herbi") )

  # make plots
  output$plot_carni <- renderPlot({
    ggplot(data = carni(), aes_string(x = input$x, y = input$y)) +
      geom_point()
  }, res = 96)
  output$plot_omni <- renderPlot({
    ggplot(data = omni(), aes_string(x = input$x, y = input$y)) +
      geom_point()
  }, res = 96)
  output$plot_herbi <- renderPlot({
    ggplot(data = herbi(), aes_string(x = input$x, y = input$y)) +
      geom_point()
  }, res = 96)

}

shinyApp(ui = ui, server = server)
```


```{r}
library(tidyverse)
library(rlang)
library(purrr)

tab_names <- c("Carnivore", "Omnivore", "Herbivore")

# create_tabs <- function(title, expr){
#   expr <- enexpr(expr)
#   expr(tabPanel(!!title, !!expr))
# }
# 
# plots <- exprs(plotOutput("plot_carni"),
#                plotOutput("plot_omni"),
#                plotOutput("plot_herbi"))
# 
# tabs <- map2(tab_names, plots, create_tabs)


# create_tabs <- function(id){
#   tabPanel(id, plotOutput(paste0("plot_", id)))
# }



select_axis <- function(id, label){
  selectInput(inputId = id,
              label = label,
              choices = c("sleep_total", "sleep_rem", "sleep_cycle", 
                          "awake", "brainwt", "bodywt"),
              selected = "sleep_total")
}

ui <- fluidPage(
  
  select_axis("x", "X-axis"),
  select_axis("y", "Y-axis"),
  
  tabsetPanel(id = "vore",
              tabPanel("Carnivore",
                       plotOutput("plot_carni")),
              tabPanel("Omnivore",
                       plotOutput("plot_omni")),
              tabPanel("Herbivore",
                       plotOutput("plot_herbi")))
)

server <- function(input, output, session) {

  # make subsets
  carni <- reactive( filter(msleep, vore == "carni") )
  omni  <- reactive( filter(msleep, vore == "omni")  )
  herbi <- reactive( filter(msleep, vore == "herbi") )

  # make plots
  output$plot_carni <- renderPlot({
    ggplot(data = carni(), aes_string(x = input$x, y = input$y)) +
      geom_point()
  }, res = 96)
  output$plot_omni <- renderPlot({
    ggplot(data = omni(), aes_string(x = input$x, y = input$y)) +
      geom_point()
  }, res = 96)
  output$plot_herbi <- renderPlot({
    ggplot(data = herbi(), aes_string(x = input$x, y = input$y)) +
      geom_point()
  }, res = 96)

}

shinyApp(ui = ui, server = server)
```


### question 2

```{r}
library(tidyverse)
library(rlang)
library(purrr)

tab_names <- c("Carnivore", "Omnivore", "Herbivore")

select_axis <- function(id, label){
  selectInput(inputId = id,
              label = label,
              choices = c("sleep_total", "sleep_rem", "sleep_cycle", 
                          "awake", "brainwt", "bodywt"),
              selected = "sleep_total")
}

ui <- fluidPage(
  
  select_axis("x", "X-axis"),
  select_axis("y", "Y-axis"),
  
  tabsetPanel(id = "vore",
              tabPanel("Carnivore",
                       plotOutput("plot_carni")),
              tabPanel("Omnivore",
                       plotOutput("plot_omni")),
              tabPanel("Herbivore",
                       plotOutput("plot_herbi")))
)

types <- c("carni", "omni", "herbi")
filtering <- function(type){
  filter(msleep, vore == type)
}

ploting <- function(data, xvar, yvar){
  ggplot(data = data, aes_string(x = xvar, y = yvar)) +
      geom_point()
}
server <- function(input, output, session) {

  # make subsets
  carni <- reactive( filtering("carni") )
  omni  <- reactive( filtering("omni")  )
  herbi <- reactive( filtering("herbi") )

  # make plots

  output$plot_carni <- renderPlot({
    ploting(carni(), input$x, input$y)
  }, res = 96)
  output$plot_omni <- renderPlot({
    ploting(omni(), input$x, input$y)
  }, res = 96)
  output$plot_herbi <- renderPlot({
    ploting(herbi(), input$x, input$y)
  }, res = 96)
  
}

shinyApp(ui = ui, server = server)
```
